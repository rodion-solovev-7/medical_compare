# Агрегатор информации о мед анализах и др услугах

## Окружение для разработки

### Создание виртуального окружения и установка зависимостей
```bash
python3.10 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Подготовка настроек по вкусу
```bash
cp config/example.py config/local.py
cp docker-compose.override.example.yml docker-compose.override.yml
```

В local.py и docker-compose.override.yml можно указать свои настройки.
Они не попадут в репозиторий.

Особенно стоит обратить внимание на настройки:
* SCRAPER_TOR_HTTP_PROXY - адрес прокси при парсинге (если прокси не используется, то оставить равным `None`)
* SCRAPER_SAVE_SCRAPED_TO_DB - будет ли сохранять парсер данные в БД (по умолчанию `False`)

### Первый запуск

После конфигурации проект запустится абсолютно пустым, без каких-либо данных в БД.
Чтобы заполнить БД данными, нужно хотя бы один раз запустить парсеры одного из источников:
```bash
scrapy crawl invitro_city
scrapy crawl invitro_analysis
```

### Готовые make-команды

Чтобы увидеть список команд, выполните:
```bash
make help
```

```
help:         Показывает все команды из Makefile
ps:           Показывает состояние сервисов
local:        Поднимает БД и др. необходимые сервисы из docker-compose.yml (и .override.yml). Сам сервер и пр. нужно запускать руками
tor:          Поднимает tor и прокси из docker-compose.yml (и .override.yml). Сам сервер и пр. нужно запускать руками
up:           Поднимает ВСЕ сервисы из docker-compose.yml (и .override.yml)
down:         Отключает ВСЕ сервисы из docker-compose.yml
destroy:      Отключает ВСЕ сервисы из docker-compose.yml и чистит их Volumes (например обнуляет БД)
runweb:       Запускает веб-сервер локально (не в контейнере). Подразумевается, что БД и другие сервисы уже запущены
runjobs:      Запускает обработчик периодических задач локально (не в контейнере). Подразумевается, что БД и другие сервисы уже запущены
runscraper:   Запускает парсер локально (не в контейнере). Подразумевается, что БД и другие сервисы уже запущены
```

Команды можно редактировать или добавлять новые в `Makefile`.

### Запуск

#### Запуск необходимых сервисов перед запуском
БД, прокси (если указаны) и прочие
```bash
make local
```

#### Веб-сервер
```bash
PYTHONPATH=. python3.10 __entry_points__/server.py
```

#### Периодические задачи
```bash
PYTHONPATH=. python3.10 __entry_points__/periodic_tasks.py
```

#### Парсер
Просмотр списка доступных парсеров
```bash
scrapy list
```

Запуск выбранного парсера
```bash
scrapy crawl SPIDER_NAME
```
